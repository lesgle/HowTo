# Raspberry Pi Wi-Fi router

hostapd, dnsmasq, iptables, webmin

**Note:** This guide was created after build as notes and wasn't tested with new deployment. Some configuration steps may be missed.

## Requirements

Raspberry Pi 3 Model B+  
Raspbian Stretch

Checking your Raspbian release:

```text
cat /etc/os-release 
PRETTY_NAME="Raspbian GNU/Linux 9 (stretch)"
```

## Architecture

ISP connects to LAN port on Raspberry and configures its IP address via DHCP.

Local clients connect to access point via Wi-Fi. `hostapd` is used to provide wireless access. `dnsmasq` provides DNS and DHCP services. `iptables` is for routing and firewall. `webmin` provides web interfaces for your access point.

## Configuration

Install `hostapd` package:

```text
apt install hostapd
```

Create a configuration file:

nano /etc/hostapd/hostapd.conf

```text
interface=wlan0
ssid=YOUR_NET_NAME
hw_mode=g
channel=7
ht_capab=[HT40][SHORT-GI-20][DSSS_CCK-40]
wmm_enabled=0
macaddr_acl=0
auth_algs=1
wpa=2
ignore_broadcast_ssid=1
wpa_passphrase=YOUR_NET_PASSWORD
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCM
```

**Note:** `ignore_broadcast_ssid=1` parameter is used to hide access point from listing. In this case you need to specify the network name and password manually on your client device.

Also "accept_mac_file=/etc/hostapd/mac_accept" can be used to limit access to specific devices. **mac_accept** file should contain the list of mac addresses.

Amend `hostapd` daemon defaults. Replace `DAEMON_CONF` with `DAEMON_CONF="/etc/hostapd/hostapd.conf"` in `/etc/default/hostapd`

Install `dnsmasq` package:

```text
apt install dnsmasq
```

Make sure ip forwarding is enabled:

```text
cat /etc/sysctl.conf | grep ip_forward
net.ipv4.ip_forward=1
```

Amend `/etc/dnsmasq.conf` configuration file. The syntax below is used to check uncommented lines only:

```text
grep -v '^#' /etc/dnsmasq.conf | grep -v '^$'

domain-needed
bogus-priv
interface=wlan0
listen-address=192.168.1.1
dhcp-range=192.168.1.101,192.168.1.120,12h
dhcp-host=11:22:33:44:55:66,192.168.1.101
```

The example below configures DHCP range from 192.168.1.101 to 192.168.1.120 and creates a static lease for a client with `11:22:33:44:55:66` MAC address.

Configure `iptables`:

```text
#!/bin/sh
PATH='/sbin'
iptables -F
iptables -X
iptables -Z
iptables -t nat -F
iptables -P INPUT   DROP
iptables -P OUTPUT  DROP
iptables -P FORWARD DROP
iptables -A INPUT  -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT   -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT   -m conntrack --ctstate INVALID -j DROP
iptables -A OUTPUT  -m conntrack --ctstate INVALID -j DROP
iptables -A FORWARD -m conntrack --ctstate INVALID -j DROP

# Allow ssh, dns, dchp and webmin from internal network
iptables -A INPUT -i wlan0 -p tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -i wlan0 -p udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -i wlan0 -p udp --dport 67:68 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -i wlan0 -p tcp --dport 10000 -m conntrack --ctstate NEW -j ACCEPT

iptables -A OUTPUT -o eth0 -d 0.0.0.0/0 -j ACCEPT
iptables -A OUTPUT -o wlan0 -d 192.168.1.0/24 -j ACCEPT
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables -A FORWARD -o eth0 -i wlan0 -s 192.168.1.0/24 -m conntrack --ctstate NEW -j ACCEPT
```

Once you run this script you can check `iptables` rules by running `iptables -S` command.

Then export the rules, it will be used in webmin later:

```text
iptables-save > /etc/my_iptables.up.rules
```

You will get the following file:

```text
cat /root/iptables-export 
# Generated by iptables-save v1.6.0 on Sat Aug 25 16:08:47 2018
*mangle
:PREROUTING ACCEPT [12647:4656372]
:INPUT ACCEPT [3849:466875]
:FORWARD ACCEPT [8728:4187257]
:OUTPUT ACCEPT [3078:868005]
:POSTROUTING ACCEPT [11805:5053762]
COMMIT
# Completed on Sat Aug 25 16:08:47 2018
# Generated by iptables-save v1.6.0 on Sat Aug 25 16:08:47 2018
*nat
:PREROUTING ACCEPT [666:51298]
:INPUT ACCEPT [200:12853]
:OUTPUT ACCEPT [50:3289]
:POSTROUTING ACCEPT [1:60]
-A POSTROUTING -o eth0 -j MASQUERADE
COMMIT
# Completed on Sat Aug 25 16:08:47 2018
# Generated by iptables-save v1.6.0 on Sat Aug 25 16:08:47 2018
*filter
:INPUT DROP [277:27307]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -i wlan0 -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -i wlan0 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -i wlan0 -p udp -m udp --dport 67:68 -m conntrack --ctstate NEW -j ACCEPT
-A INPUT -i wlan0 -p tcp -m tcp --dport 10000 -m conntrack --ctstate NEW -j ACCEPT
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -m conntrack --ctstate INVALID -j DROP
-A FORWARD -s 192.168.1.0/24 -i wlan0 -o eth0 -m conntrack --ctstate NEW -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m conntrack --ctstate INVALID -j DROP
-A OUTPUT -o eth0 -j ACCEPT
-A OUTPUT -d 192.168.1.0/24 -o wlan0 -j ACCEPT
COMMIT
# Completed on Sat Aug 25 16:08:47 2018
```

Install `webmin` package:

```text
sh -c 'echo "deb http://download.webmin.com/download/repository sarge contrib" > /etc/apt/sources.list.d/webmin.list'
wget -qO - http://www.webmin.com/jcameron-key.asc | apt-key add -
apt update
apt install webmin
```

Then logon to your `webmin` page at `https://192.168.1.1:10000/`

Go to Networking -> Linux Firewall -> Configuration -> IPv4 configuration

Make sure that `File to save/edit IPv4 rules` is pointing to `/etc/my_iptables.up.rules`, which we created earlier.

Now you can manage your Raspberry Pi using web interface.